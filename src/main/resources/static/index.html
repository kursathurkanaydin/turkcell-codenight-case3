<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turkcell TrustShield - Risk Yönetim Paneli</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 10px; margin-bottom: 20px; }
        .card-header { background-color: #2c3e50; color: white; border-radius: 10px 10px 0 0 !important; }
        .metric-card { text-align: center; padding: 20px; color: white; border-radius: 10px; }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
        .risk-high { color: #e74a3b; font-weight: bold; }
        .risk-medium { color: #f6c23e; font-weight: bold; }
        .risk-low { color: #1cc88a; font-weight: bold; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i>Turkcell TrustShield</a>
        <span class="navbar-text text-white" id="last-updated">Yükleniyor...</span>
    </div>
</nav>

<div class="container-fluid padding-bottom-3x mb-2">
    <!-- Metrics Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-primary metric-card">
                <h5>Toplam Kullanıcı</h5>
                <h2 id="total-users">-</h2>
                <i class="fas fa-users fa-2x opacity-50"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-success metric-card">
                <h5>Düşük Risk</h5>
                <h2 id="low-risk">-</h2>
                <i class="fas fa-check-circle fa-2x opacity-50"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-gradient-warning metric-card">
                <h5>Orta Risk</h5>
                <h2 id="medium-risk">-</h2>
                <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-danger metric-card">
                <h5>Yüksek Risk</h5>
                <h2 id="high-risk">-</h2>
                <i class="fas fa-radiation fa-2x opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- Fraud Cases Row -->
    <div class="row mb-4">
        <div class="col-md-4">
             <div class="card text-center">
                 <div class="card-body">
                     <h6 class="card-title text-success">Açık Case'ler</h6>
                     <h3 id="open-cases" class="text-success">-</h3>
                 </div>
             </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-warning">İncelenen Case'ler</h6>
                    <h3 id="in-progress-cases" class="text-warning">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-secondary">Kapanan Case'ler</h6>
                    <h3 id="closed-cases" class="text-secondary">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Row -->
    <div class="row">
        <!-- Recent Events -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="fas fa-stream me-2"></i>Son Olaylar (Events)</h5>
                    <button class="btn btn-sm btn-outline-light" onclick="loadData()"><i class="fas fa-sync"></i></button>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Zaman</th>
                                <th>Kullanıcı</th>
                                <th>Servis</th>
                                <th>Tip</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="events-table-body">
                            <tr><td colspan="5" class="text-center">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Decisions -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="fas fa-gavel me-2"></i>Son Kararlar (Decisions)</h5>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Tetiklenen Kural</th>
                                <th>Aksiyon</th>
                                <th>Tarih</th>
                            </tr>
                        </thead>
                        <tbody id="decisions-table-body">
                            <tr><td colspan="4" class="text-center">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rules Triggered Chart Info -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0">En Sık Tetiklenen Kurallar</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group" id="top-rules-list">
                        <li class="list-group-item">Yükleniyor...</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0">Alınan Aksiyon İstatistikleri</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group" id="top-actions-list">
                        <li class="list-group-item">Yükleniyor...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Configuration
    const API_BASE = 'http://localhost:8080'; // Adjust if needed

    document.addEventListener('DOMContentLoaded', loadData);
    
    // Auto refresh every 30 seconds
    setInterval(loadData, 30000);

    async function loadData() {
        updateTime();
        try {
            const summaryRes = await fetch(`${API_BASE}/dashboard/summary`);
            if (!summaryRes.ok) throw new Error('Network response was not ok');
            const data = await summaryRes.json();
            
            renderMetrics(data);
            renderEvents(data.recentEvents);
            renderDecisions(data.recentDecisions);
            renderStats(data.ruleTriggeredCounts, data.actionExecutedCounts);
            
        } catch (error) {
            console.error('Data loading error:', error);
            // alert('Veri yüklenirken hata oluştu. Backend çalışıyor mu?');
        }
    }

    function updateTime() {
        const now = new Date();
        document.getElementById('last-updated').innerText = 'Son Güncelleme: ' + now.toLocaleTimeString();
    }

    function renderMetrics(data) {
        document.getElementById('total-users').innerText = data.totalUsers;
        document.getElementById('low-risk').innerText = data.lowRiskUsers;
        document.getElementById('medium-risk').innerText = data.mediumRiskUsers;
        document.getElementById('high-risk').innerText = data.highRiskUsers;
        
        document.getElementById('open-cases').innerText = data.openCases;
        document.getElementById('in-progress-cases').innerText = data.inProgressCases;
        document.getElementById('closed-cases').innerText = data.closedCases;
    }

    function renderEvents(events) {
        const tbody = document.getElementById('events-table-body');
        if (!events || events.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Veri yok</td></tr>';
            return;
        }
        
        tbody.innerHTML = events.map(e => `
            <tr>
                <td>${new Date(e.timestamp).toLocaleTimeString()}</td>
                <td>${e.userId}</td>
                <td><span class="badge bg-info text-dark">${e.service}</span></td>
                <td>${e.eventType}</td>
                <td>${e.value} ${e.unit}</td>
            </tr>
        `).join('');
    }

    function renderDecisions(decisions) {
        const tbody = document.getElementById('decisions-table-body');
        if (!decisions || decisions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Veri yok</td></tr>';
            return;
        }

        tbody.innerHTML = decisions.map(d => `
            <tr>
                <td>${d.userId}</td>
                <td>${d.triggeredRules.map(r => `<span class="badge bg-secondary">${r}</span>`).join(' ')}</td>
                <td><span class="badge ${getActionBadgeClass(d.selectedAction)}">${d.selectedAction}</span></td>
                <td>${new Date(d.timestamp).toLocaleString()}</td>
            </tr>
        `).join('');
    }
    
    function renderStats(ruleCounts, actionCounts) {
        // Rules
        const rulesList = document.getElementById('top-rules-list');
        if (Object.keys(ruleCounts).length === 0) {
            rulesList.innerHTML = '<li class="list-group-item">Veri yok</li>';
        } else {
            rulesList.innerHTML = Object.entries(ruleCounts)
                .sort((a,b) => b[1] - a[1]) // Sort descending
                .map(([rule, count]) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${rule}
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `).join('');
        }

        // Actions
        const actionsList = document.getElementById('top-actions-list');
        if (Object.keys(actionCounts).length === 0) {
            actionsList.innerHTML = '<li class="list-group-item">Veri yok</li>';
        } else {
             actionsList.innerHTML = Object.entries(actionCounts)
                .sort((a,b) => b[1] - a[1])
                .map(([action, count]) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${action}
                        <span class="badge ${getActionBadgeClass(action)} rounded-pill">${count}</span>
                    </li>
                `).join('');
        }
    }

    function getActionBadgeClass(action) {
        switch(action) {
            case 'FORCE_2FA': return 'bg-warning text-dark';
            case 'TEMPORARY_BLOCK': return 'bg-danger';
            case 'OPEN_FRAUD_CASE': return 'bg-danger';
            case 'PAYMENT_REVIEW': return 'bg-info text-dark';
            case 'ANOMALY_ALERT': return 'bg-primary';
            default: return 'bg-secondary';
        }
    }
</script>

</body>
</html>
